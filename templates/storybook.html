<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë™í™”ì±… ìƒì„±ê¸° Â· CLOVA X + Gemini</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --muted:#667085; --b:#e6e8ec; --ink:#111; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Noto Sans KR',system-ui,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px;display:grid;grid-template-columns:420px 1fr;gap:20px}
    @media (max-width:960px){.wrap{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid var(--b);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .head{padding:14px 16px;border-bottom:1px solid var(--b);font-weight:700}
    .form{padding:16px;display:grid;gap:12px}
    label{font-size:13px;color:var(--muted)}
    input,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#fafbfc;outline:none}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--b);background:#111;color:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .preview{padding:16px}
    .story-title{margin:0 0 8px 0;font-size:20px}
    .scene{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;border:1px solid var(--b);border-radius:12px;background:#fff}
    .scene + .scene{margin-top:14px}
    @media (max-width:800px){.scene{grid-template-columns:1fr}}
    .scene h4{margin:0 0 6px 0}
    .scene p{margin:0;line-height:1.6}
    .scene figure{margin:0}
    .scene img{width:100%;border-radius:12px;border:1px solid var(--b);display:block}
    .code{font-family:ui-monospace,Consolas,monospace;background:#f1f3f6;border:1px solid var(--b);border-radius:10px;padding:10px;white-space:pre-wrap}
    .divider{height:1px;background:var(--b);margin:12px 0}
    .skeleton{aspect-ratio:1/1;border-radius:12px;border:1px dashed var(--b);display:grid;place-items:center;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="panel">
      <div class="head">ğŸ§¸ ë™í™” ë§Œë“¤ê¸°</div>
      <div class="form">
        <div>
          <label>ë™í™” ì œëª©</label>
          <input id="title" placeholder="ì˜ˆ: ë¯¼ì¤€ì´ì˜ ìš°ì£¼ ëŒ€ëª¨í—˜" />
        </div>
        <div class="row">
          <div>
            <label>ì£¼ì¸ê³µ ì´ë¦„</label>
            <input id="hero" placeholder="ì•„ì´ ì´ë¦„" />
          </div>
          <div>
            <label>ë‚˜ì´</label>
            <input id="age" type="number" min="1" max="12" placeholder="5" />
          </div>
        </div>
        <div>
          <label>ì£¼ì œ/ë¶„ìœ„ê¸° í‚¤ì›Œë“œ</label>
          <input id="theme" placeholder="ë”°ëœ»í•¨, ìš©ê¸°, ëª¨í—˜, ìš°ì£¼..." />
        </div>
        <div>
          <label>ì¶”ê°€ ì§€ì‹œ (ì„ íƒ)</label>
          <textarea id="extra" placeholder="3~5ê°œì˜ ì¥ë©´ìœ¼ë¡œ ë‚˜ëˆ ì¤˜, ê° ì¥ë©´ì€ 2~3ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë“±"></textarea>
        </div>
        <div>
          <button id="run" class="btn">âœ¨ ë™í™” ë§Œë“¤ê³  ì´ë¯¸ì§€ ìƒì„±</button>
          <span class="muted">CLOVA Xë¡œ í…ìŠ¤íŠ¸ â†’ Geminië¡œ ì´ë¯¸ì§€</span>
        </div>
        <div class="muted">ë¡œê·¸ì¸ í•„ìš” ì‹œ ìë™ ì•ˆë‚´ë©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <section class="panel">
      <div class="head">ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="preview" id="preview">
        ì…ë ¥ì„ ì±„ìš°ê³  â€œë™í™” ë§Œë“¤ê³  ì´ë¯¸ì§€ ìƒì„±â€ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
      </div>
    </section>
  </div>

<script>
const els = {
  title: document.getElementById("title"),
  hero: document.getElementById("hero"),
  age: document.getElementById("age"),
  theme: document.getElementById("theme"),
  extra: document.getElementById("extra"),
  run: document.getElementById("run"),
  preview: document.getElementById("preview"),
};

function setLoading(v){
  els.run.disabled = v;
  els.run.textContent = v ? "â³ ìƒì„± ì¤‘..." : "âœ¨ ë™í™” ë§Œë“¤ê³  ì´ë¯¸ì§€ ìƒì„±";
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function buildScenesWithPlaceholders(title, paragraphs){
  // ì´ë¯¸ì§€ê°€ ì•„ì§ ì—†ì„ ë•Œ í…ìŠ¤íŠ¸ì™€ ìë¦¬í‘œì‹œì(ìŠ¤ì¼ˆë ˆí†¤)ë¡œ ë¨¼ì € ë Œë”
  const blocks = paragraphs.map((p,i)=>`
    <div class="scene">
      <div>
        <h4>${escapeHtml(p.title || `ì¥ë©´ ${i+1}`)}</h4>
        <p>${escapeHtml(p.text || "")}</p>
      </div>
      <figure>
        <div class="skeleton">ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦</div>
      </figure>
    </div>
  `).join("");
  return `<h3 class="story-title">${escapeHtml(title)}</h3>${blocks}`;
}

function mergeImagesIntoScenes(title, paragraphs, images){
  // idx(1-base) ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ ë§¤ì¹­
  const byIdx = {};
  (images||[]).forEach(img => { byIdx[Number(img.idx)] = img; });

  const blocks = paragraphs.map((p,i)=>{
    const idx = i+1;
    const found = byIdx[idx];
    let imgHtml = `<div class="skeleton">ì´ë¯¸ì§€ ì—†ìŒ</div>`;
    if (found && found.file_path) {
      const src = "/" + String(found.file_path).replace(/^\/?/, "");
      imgHtml = `<img src="${src}" alt="scene image ${idx}" />`;
    }
    return `
      <div class="scene">
        <div>
          <h4>${escapeHtml(p.title || `ì¥ë©´ ${idx}`)}</h4>
          <p>${escapeHtml(p.text || "")}</p>
        </div>
        <figure>${imgHtml}</figure>
      </div>
    `;
  }).join("");

  return `<h3 class="story-title">${escapeHtml(title)}</h3>${blocks}`;
}

async function generateOnce(){
  const title = els.title.value.trim();
  const hero  = els.hero.value.trim();
  const ageRaw = (els.age.value||"").trim();
  const age = ageRaw === "" ? null : Number(ageRaw);
  const theme = els.theme.value.trim();
  const extra = els.extra.value.trim();

  if(!title){
    alert("ë™í™” ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    els.title.focus(); return;
  }

  setLoading(true);
  els.preview.innerHTML = "CLOVA Xë¡œ ë™í™” ìƒì„± ì¤‘...";

  try {
    // 1) CLOVA Xë¡œ í…ìŠ¤íŠ¸ ìƒì„±
    const body1 = { title, hero, theme, extra };
    if (age !== null && !Number.isNaN(age)) body1.age = age;

    const r1 = await fetch("/clova/make", {
      method: "POST",
      headers: {"Content-Type":"application/json", "Accept":"application/json"},
      body: JSON.stringify(body1)
    });

    const ct1 = r1.headers.get("content-type") || "";
    if(r1.status === 401){
      els.preview.innerHTML = "ğŸ” ë¡œê·¸ì¸ í•„ìš”í•©ë‹ˆë‹¤. <a href='/login/naver'>ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸</a>";
      return;
    }
    if(!r1.ok || !ct1.includes("application/json")){
      els.preview.textContent = "âŒ CLOVA ì‘ë‹µ ì˜¤ë¥˜"; return;
    }

    const story = await r1.json(); // {title, paragraphs[]}
    if(!story || !Array.isArray(story.paragraphs) || story.paragraphs.length === 0){
      els.preview.textContent = "âš ï¸ ë¬¸ë‹¨ì´ ë¹„ì–´ìˆì–´ìš”.";
      return;
    }

    // í…ìŠ¤íŠ¸ ë¨¼ì € í™”ë©´ì— ë°°ì¹˜ (ìŠ¤ì¼ˆë ˆí†¤ ì´ë¯¸ì§€)
    els.preview.innerHTML = buildScenesWithPlaceholders(story.title, story.paragraphs);

    // 2) ì„œë²„ ì €ì¥ + Gemini ì´ë¯¸ì§€ ìƒì„±
    const r2 = await fetch("/story/make", {
      method: "POST",
      headers: {"Content-Type":"application/json", "Accept":"application/json"},
      body: JSON.stringify(story)
    });

    const ct2 = r2.headers.get("content-type") || "";
    if(r2.status === 401){
      els.preview.innerHTML = "ğŸ” ë¡œê·¸ì¸ í•„ìš”í•©ë‹ˆë‹¤. <a href='/login/naver'>ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸</a>";
      return;
    }
    if(!r2.ok || !ct2.includes("application/json")){
      els.preview.textContent = "âŒ ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜"; return;
    }

    const made = await r2.json(); // {story_id, title, images: [{idx,file_path,...}]}
    els.preview.innerHTML = mergeImagesIntoScenes(story.title, story.paragraphs, made.images || []);
  } catch(e){
    els.preview.textContent = "âŒ ë„¤íŠ¸ì›Œí¬/ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: " + e;
  } finally {
    setLoading(false);
  }
}

els.run.addEventListener("click", (e)=>{ e.preventDefault(); generateOnce(); });
</script>
</body>
</html>
